---
created: '2025-12-14'
updated: '2025-12-14'
status: active
type: handoff
target: Claude-Engineer
priority: P1
---

# Handoff: Test Coverage Improvements

> Instructions pour Claude-Engineer — Augmentation coverage tests (P1)

## Context

Suite a l'audit #6 Test Coverage (2025-12-14), gaps identifies dans les hooks et services.

**Source**: `_internal/docs/reports/audit-test-coverage-baseline-2025-12.md`

---

## Scope - Phase 1 (Immediate)

### 1. Missing Hook Tests (Priority HIGH)

#### usePremiumStatus.test.js (NEW FILE)

**Location**: `__tests__/hooks/usePremiumStatus.test.js`

```javascript
// Tests to create:
describe('usePremiumStatus', () => {
  describe('initialization', () => {
    it('should return isPremium boolean');
    it('should return isLoading state');
    it('should handle RevenueCat not initialized');
  });

  describe('entitlement check', () => {
    it('should return false when no entitlements');
    it('should return true when premium_access active');
    it('should handle entitlement expiration');
  });

  describe('edge cases', () => {
    it('should handle network error gracefully');
    it('should cache status between renders');
  });
});
```

**Mock needed**: RevenueCat SDK

#### useAnalytics.test.js (NEW FILE)

**Location**: `__tests__/hooks/useAnalytics.test.js`

```javascript
describe('useAnalytics', () => {
  describe('event dispatch', () => {
    it('should track timer started');
    it('should track timer completed');
    it('should track timer abandoned');
    it('should track premium purchase');
  });

  describe('initialization', () => {
    it('should handle Mixpanel not initialized');
    it('should queue events before init');
  });
});
```

**Mock needed**: Mixpanel

---

### 2. Analytics Service Extensions (Priority MEDIUM)

**File**: `__tests__/services/analytics.test.js` (EXISTING)

**Add tests for**:

```javascript
describe('Timer Events', () => {
  it('should track timer completed with activity and duration');
  it('should track timer abandoned with elapsed time');
  it('should include palette in timer events');
});

describe('Premium Events', () => {
  it('should track premium purchased with product ID');
  it('should track premium restored');
  it('should track paywall shown');
});

describe('Error Handling', () => {
  it('should not throw when analytics not initialized');
  it('should log warning in __DEV__ mode');
});
```

---

## Implementation Guidelines

### Mock Strategy

```javascript
// __mocks__/react-native-purchases.js
export default {
  getCustomerInfo: jest.fn(() => Promise.resolve({
    entitlements: { active: {} }
  })),
  configure: jest.fn(),
};

// __mocks__/mixpanel-react-native.js
export const Mixpanel = {
  init: jest.fn(),
  track: jest.fn(),
  identify: jest.fn(),
};
```

### Test Location

```
__tests__/
├── hooks/
│   ├── usePremiumStatus.test.js  # NEW
│   ├── useAnalytics.test.js      # NEW
│   └── ... existing ...
└── services/
    └── analytics.test.js         # EXTEND
```

---

## Verification

```bash
# Run new tests
npm test -- usePremiumStatus
npm test -- useAnalytics

# Run all tests
npm test

# Check coverage improvement
npm test -- --coverage
```

### Expected Outcomes

- [ ] usePremiumStatus.test.js created (8+ tests)
- [ ] useAnalytics.test.js created (6+ tests)
- [ ] analytics.test.js extended (6+ new tests)
- [ ] All tests pass (140+ → 160+)
- [ ] No regressions

---

## Not In Scope (Future Phases)

- Component tests (Phase 2)
- Integration tests (Phase 3)
- CI/CD setup (separate decision)

---

## Notes

- Pure testing work — no feature changes
- Use existing mock patterns from `jest.setup.js`
- Follow TimeController pattern for async tests

---

**Generated by**: Atlas/Claude-Architect
**Date**: 2025-12-14
**For**: Claude-Engineer Phase 4
